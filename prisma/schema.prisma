  // This is your Prisma schema file,
  // learn more about it in the docs: https://pris.ly/d/prisma-schema

  // Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
  // Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

  generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
  }

  datasource db {
    provider = "postgresql"
  }

  //////////////////////////////////////////////////////
  // USERS
  //////////////////////////////////////////////////////

  model User {
    id          String   @id @default(uuid())
    name        String
    email       String   @unique
    password    String
    role        UserRole @default(USER)
    activeBusinessId String? // for quick access to current tenant context
     activeBusiness   Business? @relation("ActiveBusiness", fields: [activeBusinessId], references: [id])
    isActive    Boolean  @default(true)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    businessesOwned Business[]     @relation("BusinessOwner")
    memberships     BusinessUser[]

    @@map("users")
      settings Settings[]
}

  enum UserRole {
    USER
    ADMIN
    SUPER_ADMIN
  }

  //////////////////////////////////////////////////////
  // BUSINESSES (TENANTS)
  //////////////////////////////////////////////////////

  model Business {
    id          String   @id @default(uuid())
    name        String
    ownerId     String
    isActive    Boolean  @default(true)
    createdAt   DateTime @default(now())

    owner        User            @relation("BusinessOwner", fields: [ownerId], references: [id])
    users        BusinessUser[]
    roles        Role[]
    customers    Customer[]
    invoices     Invoice[]
    subscription Subscription?
     activeUsers  User[]          @relation("ActiveBusiness") 

    @@map("businesses")
    settings Settings[]
    payments Payment[]
}

  //////////////////////////////////////////////////////
  // BUSINESS USERS (User â†” Business)
  //////////////////////////////////////////////////////

  model BusinessUser {
    id          String   @id @default(uuid())
    userId      String
    businessId  String
    roleId      String
    isActive    Boolean  @default(true)
    createdAt   DateTime @default(now())

    user            User             @relation(fields: [userId], references: [id])
    business        Business         @relation(fields: [businessId], references: [id])
    role            Role             @relation(fields: [roleId], references: [id])
    userPermissions UserPermission[]

    @@unique([userId, businessId]) // prevents duplicate membership
    @@index([businessId])
    @@map("business_users")
  }

  //////////////////////////////////////////////////////
  // ROLES (Business Scoped)
  //////////////////////////////////////////////////////

  model Role {
    id          String   @id @default(uuid())
    name        String
    businessId  String
    createdAt   DateTime @default(now())

    business        Business         @relation(fields: [businessId], references: [id])
    users           BusinessUser[]
    rolePermissions RolePermission[]

    @@unique([businessId, name]) // prevents duplicate roles inside a business
    @@map("roles")
  }

  //////////////////////////////////////////////////////
  // PERMISSIONS (GLOBAL)
  //////////////////////////////////////////////////////

  model Permission {
    id        String @id @default(uuid())
    moduleId String
     module    Module   @relation(fields: [moduleId], references: [id])
    action    String // "create", "read", "update", "delete"

    rolePermissions RolePermission[]
    userPermissions UserPermission[]

    @@unique([moduleId, action]) // prevents duplicates
    @@map("permissions")
  }

      //MODULE ///
   model Module {
  id          String @id @default(uuid())
  name        String @unique

  permissions Permission[]

  @@map("modules")
}

  //////////////////////////////////////////////////////
  // ROLE -> PERMISSION
  //////////////////////////////////////////////////////

  model RolePermission {
    id            String @id @default(uuid())
    roleId        String
    permissionId  String

    role        Role       @relation(fields: [roleId], references: [id])
    permission  Permission @relation(fields: [permissionId], references: [id])

    @@unique([roleId, permissionId])
    @@map("role_permissions")
  }

  //////////////////////////////////////////////////////
  // USER -> DIRECT PERMISSION (Overrides)
  //////////////////////////////////////////////////////

  model UserPermission {
    id              String @id @default(uuid())
    businessUserId  String
    permissionId    String

    businessUser BusinessUser @relation(fields: [businessUserId], references: [id])
    permission   Permission   @relation(fields: [permissionId], references: [id])

    @@unique([businessUserId, permissionId])
    @@map("user_permissions")
  }

  //////////////////////////////////////////////////////
  // CUSTOMERS
  //////////////////////////////////////////////////////

//////////////////////////////////////////////////////
// CUSTOMER
//////////////////////////////////////////////////////
model Customer {
  id              String   @id @default(uuid())

  //////////////////////////////////////////////////////
  // BUSINESS RELATION (REPLACE TENANT)
  //////////////////////////////////////////////////////
  businessId      String
  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  //////////////////////////////////////////////////////
  // CUSTOMER DETAILS
  //////////////////////////////////////////////////////
  company         String
  vatNumber       String?
  phone           String?
  website         String?
  group           String?
  currency        String   @default("SYSTEM")
  defaultLanguage String   @default("SYSTEM")

  //////////////////////////////////////////////////////
  // MAIN ADDRESS
  //////////////////////////////////////////////////////
  address         String?
  city            String?
  state           String?
  zipCode         String?
  country         String?

  //////////////////////////////////////////////////////
  // BILLING ADDRESS
  //////////////////////////////////////////////////////
  billingStreet   String?
  billingCity     String?
  billingState    String?
  billingZipCode  String?
  billingCountry  String?

  //////////////////////////////////////////////////////
  // SHIPPING ADDRESS
  //////////////////////////////////////////////////////
  shippingStreet  String?
  shippingCity    String?
  shippingState   String?
  shippingZipCode String?
  shippingCountry String?

  //////////////////////////////////////////////////////
  // STATUS + META
  //////////////////////////////////////////////////////
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  //////////////////////////////////////////////////////
  // RELATIONS
  //////////////////////////////////////////////////////
  invoices        Invoice[]

  @@index([businessId])
  @@map("customers")
}

  //////////////////////////////////////////////////////
  // INVOICES
  //////////////////////////////////////////////////////

  model Invoice {
    id            String        @id @default(uuid())
    businessId    String
    customerId    String
    invoiceNumber String
    status        InvoiceStatus @default(UNPAID)
    invoiceDate   DateTime      @default(now())
    dueDate       DateTime?
    currency      String        @default("AED")
    poNumber      String?
    poDate        DateTime?

    //NOTE//
    adminNote String?
    terms    String?

    //totalAmount//
    subtotal Float @default(0)
    totalTax Float @default(0) 
    discount Float @default(0)
    grandTotal Float @default(0)
    
     //Business//
    createdAt     DateTime      @default(now())
    updatedAt     DateTime      @updatedAt

    pdfUrl                String?
    business Business @relation(fields: [businessId], references: [id])
    customer Customer @relation(fields: [customerId], references: [id])
    items    InvoiceItem[]

    @@unique([businessId, invoiceNumber]) // invoice numbers unique per business
    @@index([businessId])
    @@map("invoices")
      payments Payment[]
}
  enum CreatorType {
    Admin
    USER
  }

  //////////////////////////////////////////////////////
  // INVOICE ITEMS
  //////////////////////////////////////////////////////

  model InvoiceItem {
    id          String  @id @default(uuid())
    invoiceId   String
    description String
    hours Float
    rate Float
    taxPercent Float @default(0)
    taxAmount Float @default(0)
    amount  Float // hours * rate (without tax)
    createdAt   DateTime @default(now())
    invoice Invoice @relation(fields: [invoiceId], references: [id])

    @@map("invoice_items")
  }
enum InvoiceStatus {
  
  UNPAID
  GENERATED
  SENT
  PAID
  CANCELLED
}
  //////////////////////////////////////////////////////
  // SUBSCRIPTIONS (Manual Billing Ready)
  //////////////////////////////////////////////////////

  model Subscription {
    id          String   @id @default(uuid())
    businessId  String   @unique
    status      SubscriptionStatus @default(INACTIVE)

    startDate   DateTime?
    expiresAt   DateTime?

    planName    String? // "Starter", "Premium", etc.
    notes       String? // for manual deals

    createdAt   DateTime @default(now())

    business Business @relation(fields: [businessId], references: [id])

    @@map("subscriptions")
  }

  enum SubscriptionStatus {
    INACTIVE
    ACTIVE
    EXPIRED
  }

  //////////////////////////////////////////////////////
  // INVOICE STATUS
  //////////////////////////////////////////////////////
model Settings {
  id                Int      @id @default(autoincrement())
 businessId        String   @unique
 busniess            Business @relation(fields: [businessId], references: [id])
  companyName       String
  address           String?
  phone             String?
  email             String?
  website           String?
  trn               String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  accountName       String?
  accountNumber     String?
  bankAddress       String?
  bankName          String?
  companyLogo       String?
  iban              String?
  swiftCode         String?
  defaultFooterNote String?
  defaultTerms      String?

  users User[]
}

//////////////////////////////////////////////////////
// PAYMENTS
//////////////////////////////////////////////////////

model Payment {
  id            String   @id @default(uuid())

  //////////////////////////////////////////////////////
  // RELATIONS
  //////////////////////////////////////////////////////
  invoiceId     String
  businessId    String

  invoice       Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  business      Business @relation(fields: [businessId], references: [id])

  //////////////////////////////////////////////////////
  // PAYMENT DETAILS
  //////////////////////////////////////////////////////
  amount        Float
  paymentDate   DateTime
  paymentMode   String
  transactionId String?
  note          String?

  //////////////////////////////////////////////////////
  // META
  //////////////////////////////////////////////////////
  createdAt     DateTime @default(now())

  @@index([invoiceId])
  @@map("payments")
}